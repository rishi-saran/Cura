{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Appointments</title>

  <!-- keep your base styles -->
  <link rel="stylesheet" href="{% static 'assets/css/styles.css' %}">
  <!-- use the same card system as medications -->
  <link rel="stylesheet" href="{% static 'assets/css/medications.css' %}">

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

  <!-- Your Firebase init -->
  <script src="{% static 'assets/firebase/firebase-config.js' %}"></script>

  <style>
    /* page-specific tiny tweaks only */
    .dynamic-list-container { width: 100%; padding-bottom: 80px; }
    .title-card {
      background-color: #7DFFDF; border-radius: 15px; display: flex; align-items: center; justify-content: center;
      padding: 15px; width: 90%; max-width: 350px; margin: 10px auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center; box-sizing: border-box;
    }
    .title-card h1 { margin: 0; font-size: 20px; }
    .title-card img { width: 40px; height: 40px; margin-left: 10px; }
    .header { display:flex; flex-direction:column; align-items:center; gap:6px; margin-bottom: 12px; }
    .back-button { text-decoration:none; font-size:24px; color:#3D2174; position:absolute; left:15px; top:10px; }
    .empty-text { text-align:center; color:#888; margin: 24px 0; }
  </style>
</head>

<body
  data-firebase-id="{{ firebase_id }}"
  data-is-family="{{ is_family|lower }}"
  data-main-user-id="{% if is_family %}{{ user_profile.user.id }}{% else %}{{ user_profile.user.id }}{% endif %}">
  
  <div class="container">
    <div class="header">
      <a href="{% url 'home' %}" class="back-button" id="backBtn">&#8592;</a>
      <div class="title-card">
        <h1>My Appointments</h1>
        <img src="{% static 'assets/images/activity.png' %}" alt="Calendar Icon">
      </div>
    </div>

    <div id="appointment-list" class="dynamic-list-container">
      <p class="empty-text">Loading appointments...</p>
    </div>
  </div>

  <script>
  // --- FETCH (unchanged logic) ---
  async function fetchAppointments() {
    const listEl = document.getElementById('appointment-list');
    const firebaseId = document.body.getAttribute('data-firebase-id');
    const isFamilyMember = document.body.getAttribute('data-is-family') === 'true';
    const mainUserId = document.body.getAttribute('data-main-user-id');

    if (!firebaseId) {
      listEl.innerHTML = '<p class="empty-text">Error: Patient ID not found.</p>';
      return;
    }

    try {
      const userIdToUse = isFamilyMember ? String(mainUserId) : String(firebaseId);
      const familyFilterValue = isFamilyMember ? String(firebaseId) : null;

      let ref = window.db.collection('appointmentSchedules')
        .where('userId', '==', userIdToUse)
        .where('familyMemberId', '==', familyFilterValue);

      try {
        const snap = await ref.orderBy('datetime', 'desc').get();
        renderSnap(snap, listEl);
        return;
      } catch (e) {
        console.warn('Ordered query failed; falling back:', e && e.message);
      }

      const snap = await ref.get();
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b) => new Date(b.datetime) - new Date(a.datetime));
      renderArray(docs, listEl);
    } catch (err) {
      console.error('Error fetching appointments:', err);
      listEl.innerHTML = '<p class="empty-text">Error loading appointments. Please try again.</p>';
    }
  }

  // --- RENDER HELPERS ---
  function renderSnap(snap, container) {
    if (snap.empty) {
      container.innerHTML = '<p class="empty-text">No appointments scheduled.</p>';
      return;
    }
    container.innerHTML = '';
    snap.forEach(doc => {
      const el = cardFromData({ id: doc.id, ...doc.data() });
      container.appendChild(el);
    });
  }

  function renderArray(arr, container) {
    if (!arr.length) {
      container.innerHTML = '<p class="empty-text">No appointments scheduled.</p>';
      return;
    }
    container.innerHTML = '';
    arr.forEach(d => container.appendChild(cardFromData(d)));
  }

  // --- CARD (medications-style) ---
  function cardFromData(data) {
    const dt = data?.datetime ? new Date(data.datetime) : null;
    const when = dt
      ? dt.toLocaleString('en-US', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' })
      : '-';

    const doctor = escapeHtml(data.doctorName || data.doctor || 'Doctor');
    const location = escapeHtml(data.location || '-');
    const reasonText = data.reason ? String(data.reason) : 'Appointment';

    const card = document.createElement('article');
    card.className = 'template-card';
    card.dataset.docId = data.id || '';     // <-- keep the Firestore document id
    card.dataset.status = data.status || ''; // optional for quick reads

    // initial visual state from backend status
    if (data.status === 'Done') card.classList.add('done-card');
    if (data.status === 'Skipped') card.classList.add('skipped-card');

    card.innerHTML = `
      <div class="card-body">
        <h3 class="card-title">${doctor}</h3>
        <div class="card-details">
          <p><strong>When:</strong> ${when}</p>
          <p><strong>Where:</strong> ${location}</p>
          <p><strong>Notes:</strong> ${escapeHtml(reasonText)}</p>
        </div>
        <div class="card-actions" aria-hidden="true"></div>
      </div>
      <div class="card-footer">
        <button class="footer-btn done" type="button" onclick="markDone(this)">Done</button>
        <button class="footer-btn skip" type="button" onclick="markSkipped(this)">Skip</button>
      </div>
    `;
    return card;
  }

  // --- Backend status updates + UI sync ---
  async function updateAppointmentStatus(docId, newStatus, cardEl) {
    try {
      await window.db.collection('appointmentSchedules').doc(docId).update({ status: newStatus });
      // reflect UI
      if (newStatus === 'Done') {
        cardEl.classList.add('done-card');
        cardEl.classList.remove('skipped-card');
        cardEl.setAttribute('data-state', 'done');
      } else if (newStatus === 'Skipped') {
        cardEl.classList.add('skipped-card');
        cardEl.classList.remove('done-card');
        cardEl.setAttribute('data-state', 'skipped');
      } else {
        cardEl.classList.remove('skipped-card','done-card');
        cardEl.setAttribute('data-state', 'default');
      }
    } catch (err) {
      console.error('Status update failed:', err);
      alert('Could not update status. Please try again.');
    }
  }

  function markDone(btn) {
    const card = btn.closest('.template-card');
    const docId = card?.dataset?.docId;
    if (!docId) return;
    updateAppointmentStatus(docId, 'Done', card);
  }

  function markSkipped(btn) {
    const card = btn.closest('.template-card');
    const docId = card?.dataset?.docId;
    if (!docId) return;
    updateAppointmentStatus(docId, 'Skipped', card);
  }

  // small sanitiser for safety
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  document.addEventListener('DOMContentLoaded', fetchAppointments);
  </script>
  <script>
  (function () {
    var btn = document.getElementById('backBtn');
    if (!btn) return;

    btn.addEventListener('click', function (e) {
      e.preventDefault();

      var fallback = "{% url 'home' %}";
      var ref = document.referrer;

      try {
        var hasRef = !!ref;
        var sameOrigin = hasRef && new URL(ref, window.location.origin).origin === window.location.origin;

        // Prefer exact referrer if same-origin and not the current page
        if (sameOrigin && ref !== window.location.href) {
          window.location.assign(ref);
          return;
        }

        // As a secondary option, try browser history if available
        if (window.history.length > 1) {
          window.history.back();
          return;
        }
      } catch (_) {
        // ignore and fall through to fallback
      }

      // Final fallback: go to /home/
      window.location.assign(fallback);
    });
  })();
</script>

</body>
</html>